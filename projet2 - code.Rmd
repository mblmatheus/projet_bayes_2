---
title: "Salm: extra - Poisson variation in dose - reponse study"
author: BRUNO LOPES Matheus,CHERQI Meryem , TRIOMPHE Amaury
output: pdf_document
date: "15/04/2024"
---

# Importations préliminaires

```{r setup, include=FALSE}
library(MCMCpack)
library(coda)
library(ggplot2)
```

# Récupération des données

```{r}
Ndoses <- 6
Nplates <- 3
y <- structure(c(15, 16, 16, 27, 33, 20, 21, 18, 26, 41, 38, 27, 29, 
21, 33, 60, 41, 42), .Dim = c(6, 3))
x <- c(0, 10, 33, 100, 333, 1000)
y
```

# Initialisation

```{r}
alpha_star <- 0
beta <- 0
gamma <- 0
tau <- 0.1
lambda <-
lambda <- matrix(rnorm(18, 0, sqrt(1/tau)), 6, 3)
```

# Implémentation de la méthode MCMC (Hastings within Gibbs)

```{r}
# Utilisation des paramètres et de la structure du modèle définis dans le PDF
model <- function(y, x, nchain, alpha, beta, gamma, tau, lambda) {
  n <- length(x)
  m <- dim(y)[2]
  res <- matrix(NA, nchain, 4)
  for (k in 1:nchain) {
    for (i in 1:n) {
      for (j in 1:m) {
        mu_ij <- exp(alpha + beta * log(x[i] + 10) + gamma * x[i] + lambda[i, j])
        lambda[i, j] <- rnorm(1, mean = 0, sd = sqrt(1/tau))
        y[i, j] <- rpois(1, mu_ij)
      }
    }
    alpha <- rnorm(1, mean = alpha_star, sd = sqrt(1/1e6))
    beta <- rnorm(1, mean = 0, sd = sqrt(1/1e6))
    gamma <- rnorm(1, mean = 0, sd = sqrt(1/1e6))
    tau <- rgamma(1, shape = 0.001 + 9 * n * m, scale = 0.001 + 0.5 * sum(lambda^2))
    res[k, ] <- c(alpha, beta, gamma, 1/sqrt(tau))
  }
  return(res)
}
results <- model(y, x, 10000, alpha_star, beta, gamma, tau, lambda)

```

# Récupération des résultats

```{r}
burn_in <- 1000
results_post_burn_in <- results[(burn_in + 1):nrow(results), ]
moychain <- colMeans(results_post_burn_in) # moyenne
sdchain <- apply(results_post_burn_in, 2, sd) # écart type

cat("Alpha est estimé à", moychain[1], "avec un écart-type de", sdchain[1], "\n")
cat("Beta est estimé à", moychain[2], "avec un écart-type de", sdchain[2], "\n")
cat("Gamma est estimé à", moychain[3], "avec un écart-type de", sdchain[3], "\n")
cat("Sigma est estimé à", moychain[4], "avec un écart-type de", sdchain[4], "\n")

```
# Visualisation des résultats

```{r}
par(mfrow=c(2, 2), mar=c(2, 2, 2, 2))  Configure la disposition des graphiques 

# Allure des densités pour Alpha, Beta, Gamma et Sigma
plot(density(results_post_burn_in[,1]), main="Density de Alpha")
plot(density(results_post_burn_in[,2]), main="Density de Beta")
plot(density(results_post_burn_in[,3]), main="Density de Gamma")
plot(density(results_post_burn_in[,4]), main="Density de Sigma")

```

# Allure des chaines et densités
```{r}
par(ask = FALSE, mfrow = c(3, 1), mar = c(1, 1, 3, 3)) 

# Tracer les 3 premiers graphiques des chaînes de Markov
traceplot(mcmc_res)

```
